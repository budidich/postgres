# Анализ проекта


Текущий каталог: /mnt/d/dev/postgres


---



============================================================

## Файл: `docker-compose.yml`


```yml

version: '3.8'

services:
  postgres-1c:
    build: .
    container_name: postgres-1c
    restart: unless-stopped
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: your_secure_password_here
      POSTGRES_DB: postgres
      PGDATA: /var/lib/postgresql/data
      LC_ALL: ru_RU.UTF-8
      LANG: ru_RU.UTF-8
    volumes:
      # Для сохранения данных
      - postgres_data:/var/lib/postgresql/data
      # Для кастомных конфигов (опционально)
      - ./postgresql.conf:/var/lib/postgresql/data/postgresql.conf:ro
      - ./pg_hba.conf:/var/lib/postgresql/data/pg_hba.conf:ro
      # Для инициализационных скриптов
      - ./init-scripts:/docker-entrypoint-initdb.d:ro
    networks:
      - 1c-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  postgres_data:
    name: postgres-1c-data

networks:
  1c-network:
    driver: bridge


```



============================================================

## Файл: `dockerfile`


```text

FROM ubuntu:24.04

# Устанавливаем необходимые зависимости
RUN apt-get update && apt-get install -y \
    wget \
    bzip2 \
    sudo \
    libreadline8 \
    locales \
    && rm -rf /var/lib/apt/lists/*

# Устанавливаем русскую локаль для корректной работы с 1С
RUN locale-gen ru_RU.UTF-8 && locale-gen en_US.UTF-8
ENV LANG ru_RU.UTF-8
ENV LC_ALL ru_RU.UTF-8

# Создаем директорию для установки
WORKDIR /tmp

# Копируем скачанный архив PostgreSQL
COPY postgresql_17.6_1_ubuntu_24.04_x86_64_package.tar.bz2 /tmp/

# Распаковываем и устанавливаем PostgreSQL
RUN tar -xjf postgresql_17.6_1_ubuntu_24.04_x86_64_package.tar.bz2 && \
    cd postgresql_17.6_1_ubuntu_24.04_x86_64_package && \
    ./install.sh

# Создаем пользователя и директории для данных
RUN useradd -r -s /bin/bash postgres && \
    mkdir -p /var/lib/postgresql/data && \
    chown -R postgres:postgres /var/lib/postgresql && \
    mkdir -p /docker-entrypoint-initdb.d

# Копируем скрипт инициализации
COPY init-scripts/ /docker-entrypoint-initdb.d/

# Настраиваем переменные окружения
ENV PGDATA /var/lib/postgresql/data
ENV POSTGRES_USER postgres
ENV POSTGRES_PASSWORD postgres
ENV POSTGRES_DB postgres

# Экспортируем порт
EXPOSE 5432

# Переключаемся на пользователя postgres
USER postgres

# Инициализируем БД и запускаем PostgreSQL
RUN /opt/1C/v8.3/x86_64/pgpro/bin/initdb -D $PGDATA --locale=ru_RU.UTF-8

# Копируем конфигурационные файлы
COPY --chown=postgres:postgres postgresql.conf /var/lib/postgresql/data/
COPY --chown=postgres:postgres pg_hba.conf /var/lib/postgresql/data/

# Запускаем PostgreSQL
CMD ["/opt/1C/v8.3/x86_64/pgpro/bin/postgres", "-D", "/var/lib/postgresql/data"]


```



============================================================

## Файл: `pg_hba.conf`


```conf

# TYPE  DATABASE        USER            ADDRESS                 METHOD
local   all             all                                     trust
host    all             all             127.0.0.1/32            md5
host    all             all             ::1/128                 md5
host    all             all             0.0.0.0/0               md5


```



============================================================

## Файл: `postgresql.conf`


```conf

listen_addresses = '*'
port = 5432
max_connections = 100
shared_buffers = 128MB
dynamic_shared_memory_type = posix


```



============================================================

## Файл: `init-scripts/init.sql`


```sql

-- Создание базы данных для 1С
CREATE DATABASE "1C_DB" 
    WITH 
    OWNER = postgres
    ENCODING = 'UTF8'
    LC_COLLATE = 'ru_RU.UTF-8'
    LC_CTYPE = 'ru_RU.UTF-8'
    CONNECTION LIMIT = -1;

-- Настройка параметров для 1С (рекомендуемые)
ALTER DATABASE "1C_DB" SET default_transaction_isolation = 'read committed';
ALTER DATABASE "1C_DB" SET lock_timeout = '3s';


```

